---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import ToolBreathing from '../../components/ToolBreathing.astro';
import ToolGrounding from '../../components/ToolGrounding.astro';
import ToolSteps from '../../components/ToolSteps.astro';
import ToolWorryTime from '../../components/ToolWorryTime.astro';
import { ArrowLeft } from 'lucide-astro';

export async function getStaticPaths() {
  const tools = await getCollection('tools');
  return tools.map(entry => ({
    params: { id: entry.id },
    props: { entry },
  }));
}

const base = import.meta.env.BASE_URL;
const withBase = (path = "") => `${base}${path.replace(/^\//, "")}`;

const { entry } = Astro.props;
---

<Layout title={entry.data.name}>
     <div class="sticky top-0 bg-white/90 backdrop-blur-md border-b border-gray-100 z-40 px-4 py-3 flex items-center">
        <a
          href={withBase('tools/')}
          class="inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white px-3 py-2 text-sm font-semibold text-slate-800 shadow-sm hover:text-gray-900 hover:border-gray-300 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-200 focus-visible:ring-offset-1 focus-visible:ring-offset-white"
        >
            <ArrowLeft size={20} />
            <span class="leading-none">Back</span>
        </a>
        {entry.id !== 'worry-time' && (
            <span class="ml-3 font-semibold text-gray-800">{entry.data.name}</span>
        )}
    </div>

    <div class="px-4 pt-6 pb-28">
        <div class="mx-auto w-full space-y-6">
            <div class="pg-link-reset">
                {entry.id !== 'worry-time' && (
                    <p class="text-slate-800 text-lg leading-relaxed font-medium">{entry.data.summary}</p>
                )}
                {entry.id === 'grounding-54321' && (
                    <p class="mt-3 text-base text-slate-800 font-medium leading-relaxed">
                        This evidence-informed, commonly used exercise gently guides you through your senses. When you finish each step, tap the bar to move to the next.
                    </p>
                )}
            </div>

            {/* Quick how-to: Only show for timer/breathing tools, definitely NOT worry-time */}
            {entry.id !== 'worry-time' && entry.data.type === 'timer' && (
                <div class="mt-3 text-base text-slate-800 font-medium leading-relaxed rounded-lg bg-emerald-50/80 border border-emerald-100 px-4 py-3">
                    <p class="font-semibold text-emerald-900 mb-1">Quick how-to</p>
                    <ul class="space-y-1 list-disc pl-5">
                        <li>Select how many cycles you want to run below.</li>
                        <li>Start begins the sequence, Pause holds the timer, Restart resets everything.</li>
                        <li>Breathe in through your nose and out slowly through your mouth.</li>
                    </ul>
                </div>
            )}

        {entry.id === 'grounding-54321' || entry.data.type === 'steps' ? (
            <ToolGrounding tool={entry.data} />
        ) : entry.id === 'worry-time' ? (
            <ToolWorryTime tool={entry.data} />
        ) : entry.data.type === 'embed' && entry.data.embed ? (
            <div class="space-y-4 pg-link-reset">
                <div class="mt-4 w-full max-w-xl">
                    <iframe
                        src={entry.data.embed.src}
                        width="100%"
                        height={entry.data.embed.height ?? 152}
                        frameborder="0"
                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                        loading="lazy"
                        title={entry.data.name}
                        class="rounded-lg border border-black/5"
                    ></iframe>
                </div>
                <a
                    href={entry.data.embed.share_url}
                    class="inline-flex items-center text-emerald-700 hover:text-emerald-900 font-medium"
                    rel="noopener noreferrer"
                    target="_blank"
                >
                    Open in Spotify
                </a>
            </div>
        ) : entry.data.type === 'timer' ? (
            <ToolBreathing tool={entry.data} />
        ) : (
            <ToolSteps tool={entry.data} />
        )}
        </div>
    </div>
</Layout>

<script>
    const storageKey = 'parentsGuideUsedTools_v1';
    const toolId = '{entry.id}';

    const markToolUsed = () => {
        if (!toolId) return;

        try {
            const existing = JSON.parse(localStorage.getItem(storageKey) || '{}');
            existing[toolId] = new Date().toISOString();
            localStorage.setItem(storageKey, JSON.stringify(existing));
        } catch (error) {
            console.warn('Could not save tool usage', error);
        }
    };

    markToolUsed();

    document.getElementById('start-btn')?.addEventListener('click', markToolUsed);
</script>
