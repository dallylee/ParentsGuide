---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import Card from '../components/Card.astro';
import { ArrowLeft } from 'lucide-astro';
import siteIndex from '../../../content/index.json';

const toolEntries = await getCollection('tools');
const checklists = await getCollection('checklists');
const base = import.meta.env.BASE_URL;
const withBase = (path = "") => `${base}${path.replace(/^\//, "")}`;
const quickTools = siteIndex.quick_tools ?? [];

const buildHref = (route = "") => {
    const cleanedRoute = route.replace(/^\//, "");
    const normalizedRoute = cleanedRoute.endsWith('/') ? cleanedRoute : `${cleanedRoute}/`;
    return withBase(normalizedRoute);
};

const glows = [
    'rgba(207, 232, 255, 0.75)',
    'rgba(255, 227, 216, 0.7)',
    'rgba(230, 255, 216, 0.7)',
    'rgba(245, 232, 255, 0.75)'
];
---
<Layout title="Calm Tools">
    <div class="sticky top-0 bg-white/90 backdrop-blur-md border-b border-gray-100 z-40 px-4 py-3 flex items-center">
        <a
          href={withBase('')}
          class="inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white px-3 py-2 text-sm font-semibold text-slate-800 shadow-sm hover:text-gray-900 hover:border-gray-300 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-200 focus-visible:ring-offset-1 focus-visible:ring-offset-white"
        >
            <ArrowLeft size={20} />
            <span class="leading-none">Terug</span>
        </a>
        <span class="ml-3 font-semibold text-gray-800">Je Kalmte Toolkit</span>
    </div>

    <div class="px-4 pt-6 pb-28">
        <div class="mx-auto max-w-2xl space-y-8">
        <!-- Tools Section -->
        <div>
            <h2 class="text-lg font-normal text-gray-900 mb-4 px-2">Kalmerende Oefeningen</h2>
            <div class="space-y-4">
                {quickTools.map((tool, index) => {
                    const matchingTool = toolEntries.find(({ id }) => id === tool.id);
                    const title = tool.title ?? matchingTool?.data.name ?? tool.id;
                    const summary = tool.summary ?? matchingTool?.data.summary ?? '';
                    const type = tool.type ?? matchingTool?.data.type;
                    const href = buildHref(tool.route ?? `tool/${tool.id}`);

                    return (
                    <Card
                        as="a"
                        href={href}
                        class="p-6 flex items-center"
                        style={`--glow: ${glows[index % glows.length]}`}
                        data-tool-card={tool.id}
                    >
                        <span class="tool-indicator" aria-hidden="true" data-indicator></span>

                        <div
                            class="w-16 h-16 rounded-full flex items-center justify-center mr-4 text-gray-700 font-bold text-xl"
                            style={`background-color: ${glows[index % glows.length]}`}
                        >
                            {index + 1}
                        </div>
                        <div class="space-y-1">
                            <div class="flex items-center gap-2">
                                <h2 class="text-xl font-normal text-gray-900">{title}</h2>
                                {type === 'embed' && (
                                    <span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">Audio</span>
                                )}
                                {type === 'video' && (
                                    <span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">Video</span>
                                )}
                            </div>
                            <p class="text-slate-800 text-sm font-medium">{summary}</p>
                        </div>
                    </Card>
                    );
                })}
            </div>
        </div>

        <!-- Checklists Section -->
        <div>
            <h2 class="text-lg font-normal text-gray-900 mb-4 px-2">Voorbereidingschecklists</h2>
            <div class="space-y-4">
                {checklists.map((list, index) => (
                    <Card
                        as="a"
                        href={withBase(`checklist/${list.id}`)}
                        class="p-6 flex items-center"
                        style={`--glow: ${glows[(index + 2) % glows.length]}`}
                    >
                        <div
                            class="w-16 h-16 rounded-full flex items-center justify-center mr-4 text-gray-700 text-2xl"
                            style={`background-color: ${glows[(index + 2) % glows.length]}`}
                        >
                            âœ“
                        </div>
                        <div>
                            <h2 class="text-xl font-normal text-gray-900">{list.data.title}</h2>
                            <p class="text-slate-800 text-sm font-medium">Interactieve checklist</p>
                        </div>
                    </Card>
                ))}
            </div>
        </div>
        </div>
    </div>
</Layout>

<style>
    .tool-indicator {
        position: absolute;
        top: 14px;
        right: 14px;
        width: 12px;
        height: 12px;
        border-radius: 9999px;
        background: radial-gradient(circle at 30% 30%, rgba(16, 185, 129, 0.5), rgba(16, 185, 129, 0.9));
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.35);
        animation: indicatorPulse 3.8s ease-in-out infinite;
    }

    @keyframes indicatorPulse {
        0% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.35);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 0 0 10px rgba(16, 185, 129, 0.12);
            transform: scale(1.05);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.06);
            transform: scale(1);
        }
    }

    @media (prefers-reduced-motion: reduce) {
        .tool-indicator {
            animation: none;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
        }
    }
</style>

<script>
    const storageKey = 'parentsGuideUsedTools_v1';

    const parseUsedTools = () => {
        try {
            return JSON.parse(localStorage.getItem(storageKey) || '{}');
        } catch (error) {
            console.warn('Could not read used tools', error);
            return {};
        }
    };

    const usedTools = parseUsedTools();
    const cards = document.querySelectorAll('[data-tool-card]');

    cards.forEach((card) => {
        const toolId = card.getAttribute('data-tool-card');
        const indicator = card.querySelector('[data-indicator]');

        if (toolId && usedTools[toolId]) {
            indicator?.classList.add('hidden');
        }
    });
</script>
