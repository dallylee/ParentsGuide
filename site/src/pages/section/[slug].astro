---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { ArrowLeft } from 'lucide-astro';
import { unified } from 'unified';
import remarkParse from 'remark-parse';
import remarkGfm from 'remark-gfm';
import remarkRehype from 'remark-rehype';
import rehypeStringify from 'rehype-stringify';

export async function getStaticPaths() {
  const sections = await getCollection('sections');
  return sections.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const base = import.meta.env.BASE_URL;
const withBase = (path = "") => `${base}${path.replace(/^\//, "")}`;
const glows = [
  'rgba(207, 232, 255, 0.75)',
  'rgba(255, 227, 216, 0.7)',
  'rgba(230, 255, 216, 0.7)',
  'rgba(245, 232, 255, 0.75)',
];

const { entry } = Astro.props;
type SectionBlock = {
  title: string;
  content: string;
};

const applyBaseToLinks = (html: string) =>
  html.replace(/href="\/(?!\/)([^"#]*)"/g, (_, path: string) => `href="${withBase(path)}"`);

const buildSectionBlocks = (markdown: string): { intro: string; sections: SectionBlock[] } => {
  const lines = markdown.split('\n');
  const introLines: string[] = [];
  const sections: SectionBlock[] = [];
  let current: SectionBlock | null = null;

  for (const line of lines) {
    if (line.startsWith('## ')) {
      if (current) sections.push({ ...current, content: current.content.trim() });
      current = { title: line.replace(/^##\s+/, '').trim(), content: '' };
      continue;
    }

    if (current) {
      current.content += `${line}\n`;
    } else {
      introLines.push(line);
    }
  }

  if (current) sections.push({ ...current, content: current.content.trim() });

  return { intro: introLines.join('\n').trim(), sections };
};

const renderMarkdownToHtml = async (markdown: string) =>
  applyBaseToLinks(
    String(
      await unified()
        .use(remarkParse)
        .use(remarkGfm)
        .use(remarkRehype, { allowDangerousHtml: true })
        .use(rehypeStringify, { allowDangerousHtml: true })
        .process(markdown),
    ),
  );

const { intro, sections } = buildSectionBlocks(entry.body);
const introHtml = intro ? await renderMarkdownToHtml(intro) : '';
const sectionHtml = sections.length
  ? await Promise.all(
      sections.map(async (section) => ({
        title: section.title,
        html: await renderMarkdownToHtml(section.content),
      })),
    )
  : [];
const fallbackHtml = !sections.length ? await renderMarkdownToHtml(entry.body) : '';
---

<Layout title={entry.data.title}>
    <!-- Top Bar -->
    <div class="sticky top-0 bg-white/90 backdrop-blur-md border-b border-gray-100 z-40 px-4 py-4 flex items-center">
        <a href={withBase('')} class="p-2 -ml-2 text-gray-600 hover:text-gray-900 transition-colors">
            <ArrowLeft size={24} />
        </a>
        <span class="ml-2 font-semibold text-gray-800 truncate">{entry.data.title}</span>
    </div>

    <div class="bg-gradient-to-b from-slate-50 via-white to-slate-100 px-4 pb-32 pt-6">
        <div class="mx-auto flex max-w-3xl flex-col gap-4">
            <section class="card-glow p-5 md:p-6" style={`--glow: ${glows[0]}`}>
                <div class="flex flex-col gap-2">
                    <p class="text-sm font-semibold uppercase tracking-wide text-slate-500">Section</p>
                    <h1 class="text-2xl font-bold text-slate-900 md:text-3xl">{entry.data.title}</h1>
                    <p class="text-base text-slate-700 md:text-lg">{entry.data.summary}</p>
                </div>
                {introHtml && (
                    <div class="prose prose-slate mt-4 max-w-none text-base leading-relaxed prose-p:text-gray-700 prose-li:text-gray-700" set:html={introHtml} />
                )}
                {!sections.length && fallbackHtml && (
                    <div class="prose prose-slate mt-4 max-w-none text-base leading-relaxed prose-headings:font-semibold prose-h2:text-xl prose-p:text-gray-700 prose-li:text-gray-700 prose-a:inline-flex prose-a:items-center prose-a:gap-2 prose-a:rounded-lg prose-a:border prose-a:border-indigo-100 prose-a:bg-indigo-50 prose-a:px-3 prose-a:py-2 prose-a:font-semibold prose-a:text-indigo-700 prose-a:no-underline prose-a:underline-offset-4 prose-a:shadow-[0_4px_12px_rgba(79,70,229,0.15)] hover:prose-a:border-indigo-200 hover:prose-a:bg-indigo-100" set:html={fallbackHtml} />
                )}
            </section>

            {sectionHtml.map((section, idx) => (
                <section class="card-glow p-5 md:p-6" style={`--glow: ${glows[idx % glows.length]}`}>
                    <div class="flex items-start gap-3">
                        <div class="mt-1 h-2.5 w-2.5 rounded-full bg-gradient-to-br from-indigo-200 via-indigo-300 to-indigo-400 shadow-[0_0_12px_rgba(79,70,229,0.35)]"></div>
                        <h2 class="text-xl font-semibold text-slate-900 md:text-2xl">{section.title}</h2>
                    </div>
                    <div class="prose prose-slate mt-3 max-w-none text-base leading-relaxed prose-headings:font-semibold prose-h3:text-lg prose-p:text-gray-700 prose-li:text-gray-700 prose-a:inline-flex prose-a:items-center prose-a:gap-2 prose-a:rounded-lg prose-a:border prose-a:border-indigo-100 prose-a:bg-indigo-50 prose-a:px-3 prose-a:py-2 prose-a:font-semibold prose-a:text-indigo-700 prose-a:no-underline prose-a:underline-offset-4 prose-a:shadow-[0_4px_12px_rgba(79,70,229,0.15)] hover:prose-a:border-indigo-200 hover:prose-a:bg-indigo-100" set:html={section.html} />
                </section>
            ))}
        </div>
    </div>
</Layout>
