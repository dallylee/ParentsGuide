---
interface Props {
    imgSrc: string;
    typingTargets?: string[];
}

const { imgSrc, typingTargets = [] } = Astro.props;
const base = import.meta.env.BASE_URL ?? '/';
const videoSrc = `${base}${'images/hero_animated.mp4'.replace(/^\/+/, '')}`;
---
<div
    class="absolute inset-0 h-full w-full"
    data-hero-intro
    data-typing-targets={JSON.stringify(typingTargets)}
>
    <img
        src={imgSrc}
        alt="Calming background image"
        class="absolute inset-0 h-full w-full object-cover bg-white"
        loading="eager"
        decoding="async"
    />
    <video
        class="absolute inset-0 h-full w-full object-cover hero-intro-video"
        src={videoSrc}
        muted
        autoplay
        playsinline
        preload="auto"
        aria-hidden="true"
    ></video>
</div>

<script>
    const container = document.querySelector('[data-hero-intro]');
    const typingSelectors = JSON.parse(container?.getAttribute('data-typing-targets') ?? '[]');
    // These timings align the staggered fade-ins to finish with the 15s animation.
    const textFadeSeconds = [11.5, 12.8, 14.0];
    const videoDurationSeconds = 15.0;
    const fadeStartSeconds = 14.3; // Fade the video into the static image near the end.
    const fadeDurationSeconds = 0.7; // 700ms crossfade duration.

    const introKey = 'pg_hero_intro_seen'; // Remove with localStorage.removeItem('pg_hero_intro_seen') to replay.

    const video = container?.querySelector('video');

    if (container && video) {
        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        let introSeen = false;
        try {
            introSeen = Boolean(localStorage.getItem(introKey));
        } catch (error) {
            // If storage is blocked, treat as unseen but do not break the experience.
        }

        const skipIntro = prefersReduced || introSeen;
        const heroNodes = typingSelectors
            .map((selector) => (selector ? document.querySelector(selector) : null))
            .filter((el) => Boolean(el));

        const showStaticText = (forceVisible = false) => {
            if (forceVisible) {
                heroNodes.forEach((el) => el?.classList.add('is-on'));
            }
            document.body.classList.remove('hero-intro-paused');
        };

        if (skipIntro) {
            video.style.display = 'none';
            showStaticText(true);
        } else {
            document.body.classList.add('hero-intro-paused');

            const timers = [];
            let playbackStarted = false;
            const cleanupTimers = () => timers.forEach((id) => clearTimeout(id));

            const startSequence = () => {
                // Mark as seen when playback succeeds.
                try {
                    localStorage.setItem(introKey, '1');
                } catch (error) {
                    // Non-blocking.
                }

                heroNodes.forEach((el) => el?.classList.remove('is-on'));

                textFadeSeconds.forEach((delaySeconds, index) => {
                    const delay = delaySeconds ?? textFadeSeconds[textFadeSeconds.length - 1] ?? 0;
                    timers.push(
                        window.setTimeout(() => {
                            heroNodes[index]?.classList.add('is-on');
                        }, delay * 1000),
                    );
                });

                timers.push(
                    window.setTimeout(() => {
                        video.classList.add('hero-intro-video--fade');
                    }, fadeStartSeconds * 1000),
                );

                timers.push(
                    window.setTimeout(() => {
                        heroNodes.forEach((el) => el?.classList.add('is-on'));
                        video.pause();
                        video.currentTime = 0;
                        video.style.pointerEvents = 'none';
                        video.style.visibility = 'hidden';
                        document.body.classList.remove('hero-intro-paused');
                    }, (fadeStartSeconds + fadeDurationSeconds) * 1000),
                );
            };

            const failToStatic = () => {
                if (playbackStarted) return;
                cleanupTimers();
                showStaticText(true);
                video.classList.add('hero-intro-video--fade');
            };

            video.addEventListener(
                'playing',
                () => {
                    playbackStarted = true;
                    startSequence();
                },
                { once: true },
            );

            video.addEventListener('error', failToStatic, { once: true });

            const playPromise = video.play();
            if (playPromise) {
                playPromise.catch(failToStatic);
            } else {
                failToStatic();
            }

            timers.push(
                window.setTimeout(() => {
                    if (!playbackStarted) {
                        failToStatic();
                    }
                }, 2000),
            );
        }
    }
</script>

<style>
    .hero-intro-video {
        opacity: 1;
        transition: opacity 700ms ease;
        background: #fff;
    }

    .hero-intro-video--fade {
        opacity: 0;
    }

    :global(body.hero-intro-paused .hero-reveal) {
        animation: none !important;
    opacity: 0;
        transform: translateY(6px);
        transition: opacity 420ms ease, transform 420ms ease;
    }

:global(.hero-reveal.is-on),
:global(body.hero-intro-paused .hero-reveal.is-on) {
        opacity: 1;
        transform: translateY(0);
    }

    @media (prefers-reduced-motion: reduce) {
        :global(.hero-reveal) {
            transition: none !important;
        }
    }
</style>
