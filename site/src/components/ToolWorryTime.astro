---
interface Props {
    tool: any;
}

const { tool } = Astro.props;
---

<section class="space-y-6 pb-28" data-worry-root>
    <div class="rounded-xl bg-white border border-black/5 shadow-soft shadow-[0_0_22px_rgba(99,102,241,0.08)] p-4 sm:p-5 space-y-2">
        <p class="text-gray-900 font-semibold">“Worry Time” is a well-established CBT technique with strong clinical backing.</p>
        <p class="text-slate-800 text-sm font-medium">Set one daily window for worries so the rest of the day feels lighter.</p>
    </div>

    <div class="rounded-xl bg-white border border-black/5 shadow-soft shadow-[0_0_24px_rgba(16,185,129,0.1)] p-4 sm:p-5 space-y-4" data-config-card>
        <div class="space-y-3" data-state-initial>
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Choose your daily worry time</h3>
                <p class="text-sm text-slate-800 font-medium">Pick a time you can keep most days.</p>
            </div>
            <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-900" for="worry-time-input">Time of day</label>
                <input
                    id="worry-time-input"
                    type="time"
                    class="w-full rounded-xl border border-gray-200 px-4 py-4 text-lg text-gray-900 shadow-inner"
                    data-time-input
                />
            </div>
            <button type="button" class="control-btn primary w-full justify-center" data-set-time>Set worry time</button>
            <p class="text-xs text-slate-700">Worry time lasts 20 minutes.</p>
        </div>

        <div class="hidden space-y-4" data-state-configured>
            <div class="space-y-2" data-countdown-block>
                <p class="text-sm text-slate-700 font-medium">Your next worry time in:</p>
                <p class="text-2xl font-semibold text-gray-900" data-next-countdown>--:--:--</p>
            </div>

            <div class="hidden space-y-3" data-active-block>
                <div class="worry-window">
                    <div class="worry-window-header">
                        <span>Your worry time</span>
                        <span class="text-lg" data-window-countdown>20:00</span>
                    </div>
                    <div class="worry-progress" aria-hidden="true">
                        <span data-window-progress></span>
                    </div>
                </div>
            </div>

            <button type="button" class="control-btn primary w-full justify-center" data-open-worry>Enter new worry</button>

            <div class="space-y-3" data-worries-area>
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Saved worries</h3>
                    <span class="text-sm text-slate-700" data-worry-count>0 items</span>
                </div>
                <div class="space-y-3" data-worries-list></div>
                <p class="text-sm text-slate-700" data-no-worries>Anything you park will appear here.</p>
            </div>
        </div>
    </div>

    <button type="button" class="text-sm font-semibold text-emerald-700" data-change-time>Change worry time</button>

    <div class="worry-modal hidden" data-worry-modal aria-hidden="true">
        <div class="modal-backdrop" data-close-modal></div>
        <div class="modal-sheet" role="dialog" aria-modal="true" aria-label="Add a worry">
            <div class="flex items-center justify-between mb-3">
                <p class="font-semibold text-gray-900">New worry</p>
                <button type="button" class="text-sm text-slate-700 font-semibold" data-close-modal>Cancel</button>
            </div>
            <textarea
                class="w-full rounded-lg border border-gray-200 p-3 text-gray-900 shadow-inner"
                rows="3"
                placeholder="Capture the worry to revisit later"
                data-worry-input
            ></textarea>
            <div class="mt-4 flex justify-end gap-2">
                <button type="button" class="nav-chip ghost" data-close-modal>Cancel</button>
                <button type="button" class="nav-chip" data-save-worry>Save</button>
            </div>
        </div>
    </div>

    <div class="completion-overlay hidden" data-completion-overlay aria-hidden="true">
        <button type="button" class="completion-message" data-dismiss-completion>
            <span>Good job. Now breathe.</span>
        </button>
    </div>
</section>

<style>
    .control-btn {
        padding: 0.75rem 1rem;
        border-radius: 0.9rem;
        font-weight: 700;
        font-size: 0.95rem;
        border: 1px solid rgba(0,0,0,0.06);
        box-shadow: 0 8px 18px rgba(0,0,0,0.06);
        display: inline-flex;
        align-items: center;
    }

    .control-btn.primary {
        background: linear-gradient(120deg, #10b981, #22d3ee);
        color: white;
        border: none;
    }

    .nav-chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.6rem 1.1rem;
        border-radius: 999px;
        background: linear-gradient(120deg, #10b981, #22d3ee);
        color: white;
        font-weight: 700;
        border: 1px solid transparent;
        box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        transition: transform 120ms ease;
    }

    .nav-chip.ghost {
        background: white;
        color: #0f172a;
        border-color: rgba(0,0,0,0.08);
    }

    .nav-chip:active {
        transform: translateY(1px);
    }

    .worry-window {
        background: #ecfdf5;
        border: 1px solid rgba(16,185,129,0.3);
        border-radius: 1rem;
        padding: 0.9rem 1rem;
        box-shadow: inset 0 0 0 1px rgba(16,185,129,0.08);
    }

    .worry-window-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 700;
        color: #065f46;
    }

    .worry-progress {
        margin-top: 0.6rem;
        height: 4px;
        background: rgba(16,185,129,0.2);
        border-radius: 999px;
        overflow: hidden;
    }

    .worry-progress span {
        display: block;
        height: 100%;
        width: 100%;
        background: linear-gradient(90deg, #10b981, #34d399);
        transition: width 0.4s ease;
    }

    .worry-item {
        display: flex;
        gap: 0.75rem;
        align-items: flex-start;
        padding: 0.85rem 1rem;
        border-radius: 0.9rem;
        border: 1px solid rgba(0,0,0,0.05);
        background: white;
        box-shadow: 0 10px 22px rgba(0,0,0,0.04);
        transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .worry-checkbox {
        width: 1.1rem;
        height: 1.1rem;
        margin-top: 0.2rem;
        accent-color: #10b981;
        flex-shrink: 0;
    }

    .worry-text {
        color: #0f172a;
        font-weight: 600;
        word-break: break-word;
    }

    .worry-meta {
        margin-top: 0.35rem;
        font-size: 0.8rem;
        color: #475569;
    }

    .worry-item.completed .worry-text {
        text-decoration: line-through;
        color: #94a3b8;
    }

    .worry-item.completed {
        opacity: 0.7;
    }

    .worry-item.removing {
        opacity: 0;
        transform: translateY(6px);
    }

    .worry-modal {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(15,23,42,0.25);
        opacity: 0;
        pointer-events: none;
        transition: opacity 160ms ease-out;
        z-index: 40;
        padding: 1.5rem;
    }

    .worry-modal.open {
        opacity: 1;
        pointer-events: auto;
    }

    .modal-backdrop {
        position: absolute;
        inset: 0;
    }

    .modal-sheet {
        width: min(460px, 92vw);
        background: white;
        border-radius: 1rem;
        padding: 1.1rem;
        box-shadow: 0 16px 32px rgba(0,0,0,0.18);
    }

    .completion-overlay {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(15,23,42,0.2);
        opacity: 0;
        pointer-events: none;
        transition: opacity 160ms ease-out;
        z-index: 50;
        padding: 1.5rem;
    }

    .completion-overlay.show {
        opacity: 1;
        pointer-events: auto;
    }

    .completion-message {
        background: #bbf7d0;
        border: 1px solid rgba(16,185,129,0.35);
        color: #065f46;
        border-radius: 999px;
        padding: 1rem 1.5rem;
        font-weight: 700;
        box-shadow: 0 16px 30px rgba(16,185,129,0.25);
    }

    @media (prefers-reduced-motion: reduce) {
        .nav-chip,
        .control-btn,
        .worry-progress span,
        .worry-item,
        .worry-modal,
        .completion-overlay {
            transition: none !important;
        }
    }
</style>

<script>
    const root = document.querySelector('[data-worry-root]');
    const timeInput = document.querySelector('[data-time-input]');
    const setTimeButton = document.querySelector('[data-set-time]');
    const changeTimeButton = document.querySelector('[data-change-time]');
    const stateInitial = document.querySelector('[data-state-initial]');
    const stateConfigured = document.querySelector('[data-state-configured]');
    const countdownBlock = document.querySelector('[data-countdown-block]');
    const activeBlock = document.querySelector('[data-active-block]');
    const nextCountdown = document.querySelector('[data-next-countdown]');
    const windowCountdown = document.querySelector('[data-window-countdown]');
    const windowProgress = document.querySelector('[data-window-progress]');
    const openWorryButton = document.querySelector('[data-open-worry]');
    const worriesList = document.querySelector('[data-worries-list]');
    const worriesCount = document.querySelector('[data-worry-count]');
    const noWorries = document.querySelector('[data-no-worries]');
    const worryModal = document.querySelector('[data-worry-modal]');
    const worryInput = document.querySelector('[data-worry-input]');
    const saveWorryButton = document.querySelector('[data-save-worry]');
    const closeModalButtons = document.querySelectorAll('[data-close-modal]');
    const completionOverlay = document.querySelector('[data-completion-overlay]');
    const dismissCompletion = document.querySelector('[data-dismiss-completion]');

    const storage = {
        setup: 'parentsGuideWorrySetup_v1',
        notes: 'pg_worry_notes',
        session: 'parentsGuideWorrySession_v1'
    };
    const legacyNotesKey = 'parentsGuideWorryNotes_v1';

    const durationMinutes = 20;
    const durationMs = durationMinutes * 60 * 1000;
    let tickId;
    let completionTimer;
    let worries = [];
    let wasActive = false;

    const readJSON = (key, fallback) => {
        try {
            const raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : fallback;
        } catch (error) {
            console.warn('Could not read data', error);
            return fallback;
        }
    };

    const persistJSON = (key, value) => {
        try {
            localStorage.setItem(key, JSON.stringify(value));
        } catch (error) {
            console.warn('Could not save data', error);
        }
    };

    const normalizeWorries = (raw) => {
        if (!Array.isArray(raw)) return [];
        return raw
            .map((note) => {
                if (!note || !note.text) return null;
                const createdAt = typeof note.createdAt === 'number' ? note.createdAt : new Date(note.savedAt ?? Date.now()).getTime();
                const id = note.id ?? (typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}`);
                return { id, text: note.text, createdAt };
            })
            .filter(Boolean);
    };

    const setupDefaults = {
        time: '18:00',
        duration: durationMinutes
    };

    let setup = readJSON(storage.setup, setupDefaults);
    if (!setup || typeof setup !== 'object') {
        setup = { ...setupDefaults };
    }
    setup.duration = durationMinutes;

    let session = readJSON(storage.session, {});
    if (!session || typeof session !== 'object') {
        session = {};
    }

    worries = normalizeWorries(readJSON(storage.notes, []));
    if (!worries.length) {
        const legacyNotes = normalizeWorries(readJSON(legacyNotesKey, []));
        if (legacyNotes.length) {
            worries = legacyNotes;
            persistJSON(storage.notes, worries);
            localStorage.removeItem(legacyNotesKey);
        }
    }

    const formatDateKey = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const addDays = (date, days) => {
        const next = new Date(date);
        next.setDate(next.getDate() + days);
        return next;
    };

    const getTargetDate = (date, timeValue) => {
        const [hours, minutes] = timeValue.split(':').map(Number);
        const target = new Date(date);
        target.setHours(hours, minutes, 0, 0);
        return target;
    };

    const formatCountdown = (ms) => {
        const totalSeconds = Math.max(0, Math.floor(ms / 1000));
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    };

    const formatWindowCountdown = (ms) => {
        const totalSeconds = Math.max(0, Math.floor(ms / 1000));
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    };

    const getWindowState = () => {
        if (!setup?.time) {
            return { isActive: false, todayKey: formatDateKey(new Date()) };
        }
        const now = new Date();
        const todayKey = formatDateKey(now);
        const targetToday = getTargetDate(now, setup.time);
        const endToday = new Date(targetToday.getTime() + durationMs);
        const completedToday = session.completedOn === todayKey;
        const isActive = now >= targetToday && now < endToday && !completedToday;
        return { isActive, todayKey, now, targetToday, endToday, completedToday };
    };

    const setModalOpen = (open) => {
        if (!worryModal) return;
        if (open) {
            worryModal.classList.remove('hidden');
            requestAnimationFrame(() => worryModal.classList.add('open'));
            worryModal.setAttribute('aria-hidden', 'false');
            worryInput?.focus({ preventScroll: true });
        } else {
            worryModal.classList.remove('open');
            worryModal.setAttribute('aria-hidden', 'true');
            setTimeout(() => worryModal.classList.add('hidden'), 190);
            if (worryInput) worryInput.value = '';
        }
    };

    const showCompletion = () => {
        if (!completionOverlay) return;
        completionOverlay.classList.add('show');
        completionOverlay.setAttribute('aria-hidden', 'false');
        clearTimeout(completionTimer);
        completionTimer = setTimeout(() => dismissCompletionMessage(), 3000);
    };

    const dismissCompletionMessage = () => {
        if (!completionOverlay) return;
        completionOverlay.classList.remove('show');
        completionOverlay.setAttribute('aria-hidden', 'true');
    };

    const handleCompletion = (dateKey) => {
        session.completedOn = dateKey;
        persistJSON(storage.session, session);
        showCompletion();
    };

    const renderWorries = () => {
        if (!worriesList || !worriesCount || !noWorries) return;
        worriesList.innerHTML = '';

        if (!worries.length) {
            noWorries.classList.remove('hidden');
            worriesCount.textContent = '0 items';
            return;
        }

        noWorries.classList.add('hidden');
        worriesCount.textContent = `${worries.length} item${worries.length === 1 ? '' : 's'}`;

        worries
            .sort((a, b) => (b.createdAt ?? 0) - (a.createdAt ?? 0))
            .forEach((worry) => {
                const item = document.createElement('div');
                item.className = 'worry-item';
                item.dataset.worryId = worry.id;

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'worry-checkbox';
                checkbox.setAttribute('aria-label', 'Mark worry as complete');

                const textWrap = document.createElement('div');
                const text = document.createElement('p');
                text.className = 'worry-text';
                text.textContent = worry.text;
                const stamp = new Date(worry.createdAt).toLocaleString([], {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const meta = document.createElement('p');
                meta.className = 'worry-meta';
                meta.textContent = `Saved ${stamp}`;
                textWrap.appendChild(text);
                textWrap.appendChild(meta);

                item.appendChild(checkbox);
                item.appendChild(textWrap);
                worriesList.appendChild(item);
            });
    };

    const saveWorry = () => {
        if (!worryInput) return;
        const text = worryInput.value.trim();
        if (!text) return;
        const id = typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}`;
        worries = [{ id, text, createdAt: Date.now() }, ...worries];
        persistJSON(storage.notes, worries);
        setModalOpen(false);
        renderWorries();
    };

    const updateStateVisibility = (configured) => {
        stateInitial?.classList.toggle('hidden', configured);
        stateConfigured?.classList.toggle('hidden', !configured);
    };

    const clearTick = () => {
        if (tickId) {
            clearInterval(tickId);
            tickId = null;
        }
    };

    const updateTimer = () => {
        if (!setup?.time || !nextCountdown || !windowCountdown || !windowProgress) return;

        const { isActive, todayKey, now, targetToday, endToday, completedToday } = getWindowState();

        countdownBlock?.classList.toggle('hidden', isActive);
        activeBlock?.classList.toggle('hidden', !isActive);

        if (isActive) {
            const remaining = endToday - now;
            windowCountdown.textContent = formatWindowCountdown(remaining);
            const progress = Math.max(0, Math.min(1, remaining / durationMs));
            windowProgress.style.width = `${progress * 100}%`;
            wasActive = true;
            return;
        }

        if (wasActive && session.completedOn !== todayKey) {
            handleCompletion(todayKey);
        }
        wasActive = false;

        if (now >= endToday && !completedToday) {
            session.completedOn = todayKey;
            persistJSON(storage.session, session);
        }

        const nextTarget = now < targetToday && !completedToday ? targetToday : getTargetDate(addDays(now, 1), setup.time);
        nextCountdown.textContent = formatCountdown(nextTarget - now);
        windowCountdown.textContent = formatWindowCountdown(durationMs);
        windowProgress.style.width = '100%';
    };

    const setConfigured = (timeValue) => {
        setup.time = timeValue;
        setup.duration = durationMinutes;
        persistJSON(storage.setup, setup);
        session.completedOn = null;
        persistJSON(storage.session, session);
        updateStateVisibility(true);
        updateTimer();
        clearTick();
        tickId = setInterval(updateTimer, 1000);
    };

    const resetConfiguration = () => {
        setup = { ...setupDefaults };
        persistJSON(storage.setup, setup);
        session.completedOn = null;
        persistJSON(storage.session, session);
        updateStateVisibility(false);
        if (timeInput) timeInput.value = setup.time;
        clearTick();
    };

    const handleWorryCompletion = (item, id) => {
        if (!item) return;
        item.classList.add('completed');
        const previousCount = worries.length;
        setTimeout(() => {
            item.classList.add('removing');
        }, 30);
        setTimeout(() => {
            worries = worries.filter((worry) => worry.id !== id);
            persistJSON(storage.notes, worries);
            renderWorries();
            if (previousCount > 0 && worries.length === 0) {
                const { isActive, todayKey } = getWindowState();
                if (isActive) {
                    handleCompletion(todayKey);
                }
            }
        }, 750);
    };

    const bootstrap = () => {
        if (timeInput) timeInput.value = setup.time ?? setupDefaults.time;
        const configured = Boolean(setup?.time && localStorage.getItem(storage.setup));
        updateStateVisibility(configured);
        renderWorries();
        if (configured) {
            updateTimer();
            tickId = setInterval(updateTimer, 1000);
        }
    };

    setTimeButton?.addEventListener('click', () => {
        const value = timeInput?.value || setupDefaults.time;
        setConfigured(value);
    });

    changeTimeButton?.addEventListener('click', () => {
        resetConfiguration();
    });

    openWorryButton?.addEventListener('click', () => setModalOpen(true));
    saveWorryButton?.addEventListener('click', saveWorry);
    closeModalButtons.forEach((button) => button.addEventListener('click', () => setModalOpen(false)));

    worriesList?.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLInputElement)) return;
        if (!target.classList.contains('worry-checkbox')) return;
        const item = target.closest('[data-worry-id]');
        const id = item?.dataset.worryId;
        if (id) {
            handleWorryCompletion(item, id);
        }
    });

    dismissCompletion?.addEventListener('click', dismissCompletionMessage);

    window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') setModalOpen(false);
    });

    bootstrap();
</script>
