---
/**
 * InstallPrompt.astro
 * - Mobile-only PWA install affordance.
 * - Android/Chromium: uses beforeinstallprompt.
 * - iOS: shows A2HS instructions.
 * - Appears only on the homepage, only after intro animation, only for 2 homepage loads total.
 */

const base = import.meta.env.BASE_URL;
const normaliseBase = (b: string) => (b.endsWith('/') ? b : `${b}/`);
const baseWithSlash = normaliseBase(base);
---

<div
  class="fixed top-3 right-3 z-50 hidden"
  data-install-container
>
  <button
    type="button"
    class="inline-flex items-center gap-2 rounded-full border border-gray-300 bg-gray-100/90 px-3 py-2 text-sm font-semibold text-slate-800 shadow-sm backdrop-blur-md transition hover:bg-gray-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-400"
    aria-label="Add this guide to your Home Screen"
  >
    <span aria-hidden="true" class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-white/80 text-slate-700 border border-gray-200">
      â†‘
    </span>
    <span>Add to Home</span>
  </button>
</div>

<!-- iOS instructions modal -->
<div
  class="fixed inset-0 z-[60] hidden"
  data-install-modal
  aria-hidden="true"
>
  <div class="absolute inset-0 bg-black/40 backdrop-blur-[1px]"></div>

  <div class="absolute left-1/2 top-1/2 w-[92vw] max-w-sm -translate-x-1/2 -translate-y-1/2 rounded-2xl bg-white p-5 shadow-2xl border border-black/5">
    <h2 class="text-lg font-semibold text-slate-900">Add this guide to your Home Screen</h2>
    <ol class="mt-3 space-y-2 text-sm leading-relaxed text-slate-800">
      <li><span class="font-semibold">1)</span> Tap the <span class="font-semibold">Share</span> button (square with arrow).</li>
      <li><span class="font-semibold">2)</span> Choose <span class="font-semibold">Add to Home Screen</span>.</li>
    </ol>
    <p class="mt-3 text-sm text-slate-700">
      Notes are stored on this device only. If you clear site data or switch devices, you may lose saved notes.
    </p>

    <div class="mt-4 flex items-center justify-end gap-3">
      <button
        type="button"
        class="rounded-xl px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-gray-100"
        data-install-modal-close
      >
        OK
      </button>
      <button
        type="button"
        class="rounded-xl px-4 py-2 text-sm font-semibold text-red-600 hover:bg-red-50"
        data-install-modal-suppress
      >
        Suppress dialogues
      </button>
    </div>
  </div>
</div>

<script>
  const baseWithSlash = ${JSON.stringify(baseWithSlash)};

  const container = document.querySelector('[data-install-container]');
  const button = container?.querySelector('button');
  const modal = document.querySelector('[data-install-modal]');
  const modalClose = modal?.querySelector('[data-install-modal-close]');
  const modalSuppress = modal?.querySelector('[data-install-modal-suppress]');

  // Storage keys
  const seenKey = 'pg_install_prompt_home_seen_count'; // number of homepage loads where prompt was eligible and shown
  const suppressKey = 'pg_install_prompt_suppressed';  // '1' to never show again

  const isProbablyMobile = () => {
    // Avoid desktop prompt; allow phones (and small tablets, if they present as mobile).
    const smallScreen = window.matchMedia('(max-width: 820px)').matches;
    const coarsePointer = window.matchMedia('(pointer: coarse)').matches;
    return smallScreen && coarsePointer;
  };

  const isIOS = () => {
    const ua = navigator.userAgent || '';
    const iOSDevice = /iPad|iPhone|iPod/.test(ua);
    const iPadOS13Plus = navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1;
    return iOSDevice || iPadOS13Plus;
  };

  const isStandalone = () => {
    // iOS Safari uses navigator.standalone; others use display-mode.
    return window.matchMedia('(display-mode: standalone)').matches || (navigator.standalone === true);
  };

  const isHomePage = () => {
    const path = window.location.pathname || '/';
    // Astro BASE_URL-safe check
    return path === baseWithSlash || path === baseWithSlash.slice(0, -1);
  };

  const getSeenCount = () => {
    try { return Number(localStorage.getItem(seenKey) || '0'); } catch { return 0; }
  };

  const incrementSeenCount = () => {
    try {
      const next = getSeenCount() + 1;
      localStorage.setItem(seenKey, String(next));
      return next;
    } catch {
      return 999;
    }
  };

  const isSuppressed = () => {
    try { return localStorage.getItem(suppressKey) === '1'; } catch { return false; }
  };

  const show = () => container?.classList.remove('hidden');
  const hide = () => container?.classList.add('hidden');

  const openModal = () => {
    if (!modal) return;
    modal.classList.remove('hidden');
    modal.setAttribute('aria-hidden', 'false');
  };

  const closeModal = () => {
    if (!modal) return;
    modal.classList.add('hidden');
    modal.setAttribute('aria-hidden', 'true');
  };

  const waitForIntroToFinish = () => {
    // The intro component toggles body.hero-intro-paused during the animation.
    // We only show the install affordance after that class is removed.
    return new Promise((resolve) => {
      const done = () => resolve(true);

      // If intro not present or already finished
      if (!document.body.classList.contains('hero-intro-paused')) return done();

      const obs = new MutationObserver(() => {
        if (!document.body.classList.contains('hero-intro-paused')) {
          obs.disconnect();
          done();
        }
      });

      obs.observe(document.body, { attributes: true, attributeFilter: ['class'] });

      // Safety timeout, do not block forever
      setTimeout(() => {
        try { obs.disconnect(); } catch {}
        done();
      }, 12000);
    });
  };

  let deferredPrompt = null;

  const setupAndroidPrompt = () => {
    window.addEventListener('beforeinstallprompt', (e) => {
      // Chromium only; prevent mini-infobar
      e.preventDefault();
      deferredPrompt = e;
    });
  };

  const maybeEnable = async () => {
    hide();

    if (!container || !button) return;
    if (!isHomePage()) return;
    if (!isProbablyMobile()) return;
    if (isStandalone()) return;
    if (isSuppressed()) return;

    // Only show for 2 homepage loads total
    if (getSeenCount() >= 2) return;

    await waitForIntroToFinish();

    // Re-check after waiting
    if (!isHomePage() || isStandalone() || isSuppressed() || getSeenCount() >= 2) return;

    // Mark this homepage load as one of the limited displays
    incrementSeenCount();

    show();
  };

  // Button behaviour
  const onClick = async () => {
    if (isIOS()) {
      openModal();
      return;
    }

    // Android/Chromium install
    if (deferredPrompt) {
      try {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
      } catch {}
      deferredPrompt = null;
      hide();
      return;
    }

    // If no deferred prompt, provide a gentle fallback
    openModal();
  };

  button?.addEventListener('click', onClick);

  modalClose?.addEventListener('click', () => closeModal());

  modalSuppress?.addEventListener('click', () => {
    try { localStorage.setItem(suppressKey, '1'); } catch {}
    closeModal();
    hide();
  });

  // Dismiss modal when tapping backdrop
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  // Initialise
  setupAndroidPrompt();
  window.addEventListener('pageshow', () => { maybeEnable(); });
</script>
